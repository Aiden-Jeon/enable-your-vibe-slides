<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>05 - Genie MCP - Enable Your Vibe</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reset.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/theme/black.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/highlight/monokai.css">
    <link rel="stylesheet" href="../../shared/assets/theme.css">
</head>
<body>
    <!-- Sidebar Navigation -->
    <button id="sidebar-toggle" class="sidebar-toggle"><span></span><span></span><span></span></button>
    <nav id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>Enable Your Vibe</h2>
            <p>Vibe Coding í•¸ì¦ˆì˜¨ ì„¸ì…˜</p>
        </div>
        <ul class="sidebar-sections"></ul>
    </nav>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div class="reveal"><div class="slides">

        <!-- Slide 1: Title -->
        <section>
            <h1>Genie MCP</h1>
            <p>Genie MCP ì„œë²„ ë§Œë“¤ê¸°</p>
            <p style="margin-top: 2em; font-size: 0.7em; color: var(--ev-text-muted);">
                Section 05 | Hands-on | 30ë¶„
            </p>
            <aside class="notes">
                ì´ë²ˆ ì„¹ì…˜ì—ì„œëŠ” Databricks Genie Spaceë¥¼ APIë¡œ ì§ì ‘ ìƒì„±í•˜ê³ ,
                ì´ë¥¼ MCP ì„œë²„ë¡œ ë˜í•‘í•˜ì—¬ Claude Codeì—ì„œ ìì—°ì–´ë¡œ ë°ì´í„°ë¥¼ ì§ˆì˜í•  ìˆ˜ ìˆëŠ” í™˜ê²½ì„ êµ¬ì¶•í•©ë‹ˆë‹¤.
                Section 03ì—ì„œ ë°°ìš´ MCP ì•„í‚¤í…ì²˜ë¥¼ ì‹¤ì œë¡œ ì ìš©í•˜ëŠ” í•µì‹¬ ì‹¤ìŠµì…ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 2: í•™ìŠµ ëª©í‘œ -->
        <section>
            <h2>í•™ìŠµ ëª©í‘œ</h2>
            <ul>
                <li class="fragment">Genie Space ìƒì„± APIì™€ serialized_space í˜•ì‹ì„ ì´í•´í•œë‹¤</li>
                <li class="fragment">FastMCPë¡œ Space ìƒì„± + ì§ˆì˜ MCP ì„œë²„ë¥¼ êµ¬í˜„í•œë‹¤</li>
                <li class="fragment">Claude Codeì—ì„œ Genie MCPë¥¼ ì—°ê²°í•˜ì—¬ Space ìƒì„± ë° ë°ì´í„° ì§ˆì˜</li>
            </ul>
            <div class="emphasis-box fragment" style="margin-top: 1.5em;">
                <strong>í•µì‹¬:</strong> Space ìƒì„±ë¶€í„° ì§ˆì˜ê¹Œì§€ â€” Genieì˜ ì „ì²´ ë¼ì´í”„ì‚¬ì´í´ì„ APIë¡œ ì œì–´í•©ë‹ˆë‹¤
            </div>
            <aside class="notes">
                ì„¸ ê°€ì§€ í•™ìŠµ ëª©í‘œë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.
                ì²«ì§¸, Genie Spaceë¥¼ APIë¡œ ì§ì ‘ ìƒì„±í•˜ëŠ” ë°©ë²•ì„ ë°°ì›ë‹ˆë‹¤. UIì—ì„œë§Œ ê°€ëŠ¥í•˜ë˜ ê²ƒì„ ì½”ë“œë¡œ ìë™í™”í•©ë‹ˆë‹¤.
                ë‘˜ì§¸, ì´ APIë¥¼ FastMCPë¡œ ê°ì‹¸ì„œ MCP ì„œë²„ë¥¼ ë§Œë“­ë‹ˆë‹¤.
                ì…‹ì§¸, ë§Œë“  ì„œë²„ë¥¼ Claude Codeì— ì—°ê²°í•´ì„œ Space ìƒì„±ê³¼ ë°ì´í„° ì§ˆì˜ë¥¼ ëª¨ë‘ ìˆ˜í–‰í•©ë‹ˆë‹¤.
                í•µì‹¬ì€ Genieì˜ ì „ì²´ ë¼ì´í”„ì‚¬ì´í´ì„ ì½”ë“œë¡œ ì œì–´í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 3: Databricks Genie Spaceë€? -->
        <section>
            <h2>Databricks Genie Spaceë€?</h2>
            <div class="columns">
                <div>
                    <h3>ìì—°ì–´ ë°ì´í„° ì§ˆì˜ AI</h3>
                    <ul>
                        <li>ìì—°ì–´ ì§ˆë¬¸ì„ SQLë¡œ ë³€í™˜</li>
                        <li>Databricks í…Œì´ë¸”ì—ì„œ ë°ì´í„° ì¡°íšŒ</li>
                        <li>ê²°ê³¼ë¥¼ ìì—°ì–´ë¡œ ìš”ì•½í•˜ì—¬ ë°˜í™˜</li>
                        <li>ëŒ€í™”í˜• ì¸í„°í˜ì´ìŠ¤ ì§€ì›</li>
                    </ul>
                </div>
                <div>
                    <h3>í™œìš© ì‚¬ë¡€</h3>
                    <ul>
                        <li>"ì´ë²ˆ ë‹¬ ë§¤ì¶œ í•©ê³„ëŠ”?"</li>
                        <li>"ê°€ì¥ ë§ì´ íŒ”ë¦° ìƒí’ˆ Top 5"</li>
                        <li>"ì§€ë‚œ ë¶„ê¸° ëŒ€ë¹„ ì„±ì¥ë¥ "</li>
                        <li>"ê³ ê° ì´íƒˆë¥  ì¶”ì´"</li>
                    </ul>
                </div>
            </div>
            <aside class="notes">
                Genie SpaceëŠ” Databricksì—ì„œ ì œê³µí•˜ëŠ” ìì—°ì–´ ë°ì´í„° ì§ˆì˜ ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.
                ì‚¬ìš©ìê°€ ìì—°ì–´ë¡œ ì§ˆë¬¸í•˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œ SQLì„ ìƒì„±í•˜ê³ ,
                Databricks í…Œì´ë¸”ì—ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒí•œ ë’¤ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
                ì›¹ UIë¿ ì•„ë‹ˆë¼ APIë¥¼ í†µí•´ì„œë„ ì ‘ê·¼ì´ ê°€ëŠ¥í•œë°,
                ì´ APIë¥¼ MCP ì„œë²„ë¡œ ë§Œë“¤ë©´ Claude Codeì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ì§ˆì˜í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 4: Genie API êµ¬ì¡° -->
        <section>
            <h2>Genie API êµ¬ì¡°</h2>
            <table>
                <thead>
                    <tr>
                        <th>ê¸°ëŠ¥</th>
                        <th>ë©”ì„œë“œ</th>
                        <th>ì—”ë“œí¬ì¸íŠ¸</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="fragment">
                        <td><strong>Space ìƒì„±</strong></td>
                        <td><code>POST</code></td>
                        <td><code>/api/2.0/genie/spaces</code></td>
                    </tr>
                    <tr class="fragment">
                        <td><strong>ëŒ€í™” ìƒì„±</strong></td>
                        <td><code>POST</code></td>
                        <td><code>/api/2.0/genie/spaces/{id}/conversations</code></td>
                    </tr>
                    <tr class="fragment">
                        <td><strong>ë©”ì‹œì§€ ì „ì†¡</strong></td>
                        <td><code>POST</code></td>
                        <td><code>.../conversations/{id}/messages</code></td>
                    </tr>
                    <tr class="fragment">
                        <td><strong>ê²°ê³¼ ì¡°íšŒ</strong></td>
                        <td><code>GET</code></td>
                        <td><code>.../messages/{id}</code></td>
                    </tr>
                </tbody>
            </table>
            <div class="emphasis-box fragment" style="margin-top: 1em;">
                <strong>ì¸ì¦:</strong> Bearer í† í° &mdash; <code>Authorization: Bearer {token}</code>
            </div>
            <aside class="notes">
                Genie APIëŠ” í¬ê²Œ ë‘ ë¶€ë¶„ìœ¼ë¡œ ë‚˜ë‰©ë‹ˆë‹¤.
                ë¨¼ì € Space ìƒì„± API â€” POST /genie/spacesë¡œ ìƒˆ Spaceë¥¼ ë§Œë“­ë‹ˆë‹¤.
                ê·¸ ë‹¤ìŒ ì§ˆì˜ API â€” ëŒ€í™” ìƒì„±, ë©”ì‹œì§€ ì „ì†¡, ê²°ê³¼ ì¡°íšŒì˜ 3ë‹¨ê³„ì…ë‹ˆë‹¤.
                ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” Space ìƒì„±ë¶€í„° ì§ˆì˜ê¹Œì§€ ì „ì²´ íë¦„ì„ ë‹¤ë£¹ë‹ˆë‹¤.
                ì¸ì¦ì€ Databricks Personal Access Tokenì„ Bearer ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 5: ì „ì²´ API íë¦„ ë‹¤ì´ì–´ê·¸ë¨ -->
        <section>
            <h2>ì „ì²´ API íë¦„</h2>
            <div class="diagram">
<pre style="background: transparent; border: none; box-shadow: none; text-align: center; font-size: 0.85em;">
Client                               Genie API
  |                                      |
  |  POST /genie/spaces                  |
  |    { title, warehouse_id,            |
  |     serialized_space }               |
  |------------------------------------->|
  |  { space_id }                        |
  |<-------------------------------------|
  |                                      |
  |  POST /spaces/{id}/conversations     |
  |------------------------------------->|
  |  { conversation_id }                 |
  |<-------------------------------------|
  |                                      |
  |  POST /conversations/{id}/messages   |
  |    { content: "Top 10 products?" }   |
  |------------------------------------->|
  |  { message_id }                      |
  |<-------------------------------------|
  |                                      |
  |  GET /messages/{id}  (polling)       |
  |------------------------------------->|
  |  { status: "COMPLETED", ... }        |
  |<-------------------------------------|
</pre>
            </div>
            <aside class="notes">
                ì „ì²´ íë¦„ì„ ë³´ë©´: ë¨¼ì € Spaceë¥¼ ìƒì„±í•˜ì—¬ space_idë¥¼ ë°›ìŠµë‹ˆë‹¤.
                ê·¸ ë‹¤ìŒ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ê³ , ì§ˆë¬¸ì„ ë³´ë‚´ê³ , ê²°ê³¼ë¥¼ í´ë§í•©ë‹ˆë‹¤.
                Space ìƒì„± ì‹œ serialized_space í•„ë“œê°€ í•µì‹¬ì¸ë°,
                ì´ê²ƒì€ í…Œì´ë¸” ì •ë³´, ì§€ì‹œì‚¬í•­, ì˜ˆì œ ì§ˆë¬¸ì„ protobuf v2 JSON í˜•ì‹ìœ¼ë¡œ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.
                ì´ ì „ì²´ íë¦„ì„ MCP ì„œë²„ë¡œ ë˜í•‘í•  ê²ƒì…ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 6: êµ¬í˜„ ì „ëµ â€” 3ê°œ Tool -->
        <section>
            <h2>MCP ì„œë²„ êµ¬í˜„ ì „ëµ: 3ê°œ Tool</h2>
            <table>
                <thead>
                    <tr>
                        <th>Tool</th>
                        <th>ê¸°ëŠ¥</th>
                        <th>í•µì‹¬ íŒŒë¼ë¯¸í„°</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="fragment" data-fragment-index="1">
                        <td><code>create_genie_space</code></td>
                        <td>Space ìƒì„±</td>
                        <td>title, tables, instructions</td>
                    </tr>
                    <tr class="fragment" data-fragment-index="1">
                        <td><code>ask_genie</code></td>
                        <td>ìƒˆ ëŒ€í™” + ì§ˆì˜</td>
                        <td>space_id, question</td>
                    </tr>
                    <tr class="fragment" data-fragment-index="1">
                        <td><code>continue_conversation</code></td>
                        <td>í›„ì† ì§ˆì˜</td>
                        <td>space_id, conversation_id, question</td>
                    </tr>
                </tbody>
            </table>
            <div class="emphasis-box fragment" style="margin-top: 1em;">
                <strong>ì„¤ê³„ í¬ì¸íŠ¸:</strong> space_idë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ ì—¬ëŸ¬ Spaceë¥¼ ìœ ì—°í•˜ê²Œ ì‚¬ìš©
            </div>
            <aside class="notes">
                MCP ì„œë²„ëŠ” 3ê°œì˜ toolì„ ì œê³µí•©ë‹ˆë‹¤.
                create_genie_spaceëŠ” ìƒˆ Spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤. í…Œì´ë¸” ì •ë³´ì™€ ì§€ì‹œì‚¬í•­ì„ ë°›ì•„ serialized_spaceë¥¼ ë‚´ë¶€ì—ì„œ êµ¬ì„±í•©ë‹ˆë‹¤.
                ask_genieëŠ” ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ê³  ì§ˆì˜í•©ë‹ˆë‹¤. ëŒ€í™” ìƒì„±, ë©”ì‹œì§€ ì „ì†¡, í´ë§ì„ ëª¨ë‘ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                continue_conversationì€ ê¸°ì¡´ ëŒ€í™”ì— í›„ì† ì§ˆë¬¸ì„ í•©ë‹ˆë‹¤.
                í•µì‹¬ ì„¤ê³„ í¬ì¸íŠ¸ëŠ” space_idë¥¼ í™˜ê²½ë³€ìˆ˜ê°€ ì•„ë‹Œ íŒŒë¼ë¯¸í„°ë¡œ ë°›ëŠ” ê²ƒì…ë‹ˆë‹¤.
                ì´ë ‡ê²Œ í•˜ë©´ ì—¬ëŸ¬ Spaceë¥¼ ìœ ì—°í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </aside>
        </section>

        <!-- ============================================================ -->
        <!-- Exercise 00: ì‚¬ì „ í™˜ê²½ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
        <!-- ============================================================ -->

        <section>
            <h2>Exercise 00: ì‚¬ì „ í™˜ê²½ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);">ì‹¤ìŠµ ì‹œì‘ ì „ í™˜ê²½ ì„¤ì •ì„ ê²€ì¦í•©ë‹ˆë‹¤</p>
            <pre><code class="language-bash" data-trim>
python exercise_00_checklist.py
            </code></pre>
            <table style="font-size: 0.75em; margin-top: 0.8em;">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ê²€ì¦ í•­ëª©</th>
                        <th>ë°©ë²•</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>ì¸ì¦ ì •ë³´ í™•ì¸</td>
                        <td><code>.env</code> â†’ <code>databricks CLI</code> â†’ ê¸°ë³¸ê°’ì—ì„œ ìë™ í•´ì„</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>í˜¸ìŠ¤íŠ¸ ì—°ê²°</td>
                        <td><code>GET /api/2.0/clusters/spark-versions</code></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>SQL Warehouse</td>
                        <td><code>SELECT 1</code> ì‹¤í–‰ í™•ì¸</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>ë°ì´í„° ìŠ¤í‚¤ë§ˆ</td>
                        <td><code>shared.fashion_recommendations</code> í…Œì´ë¸” í™•ì¸</td>
                    </tr>
                </tbody>
            </table>
            <div class="emphasis-box" style="margin-top: 0.8em;">
                ëª¨ë“  âœ… í™•ì¸ í›„ Exercise 01aë¡œ ì§„í–‰í•˜ì„¸ìš”
            </div>
            <aside class="notes">
                ì‹¤ìŠµì„ ì‹œì‘í•˜ê¸° ì „ì— í™˜ê²½ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
                exercise_00_checklist.pyë¥¼ ì‹¤í–‰í•˜ë©´ 4ë‹¨ê³„ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ê²€ì¦í•©ë‹ˆë‹¤.
                ì²«ì§¸, ì¸ì¦ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. .env íŒŒì¼ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ databricks CLI ì„¤ì •ì—ì„œ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                WAREHOUSE_IDë„ APIë¡œ ìë™ ì¡°íšŒë˜ë¯€ë¡œ, databricks CLIë§Œ ì„¤ì •í•˜ë©´ ë³„ë„ ì„¤ì • ì—†ì´ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                ë‘˜ì§¸, Databricks í˜¸ìŠ¤íŠ¸ì— ì—°ê²°í•  ìˆ˜ ìˆëŠ”ì§€ ê²½ëŸ‰ API í˜¸ì¶œë¡œ í™•ì¸í•©ë‹ˆë‹¤.
                ì…‹ì§¸, SQL Warehouseê°€ ì‘ë™í•˜ëŠ”ì§€ SELECT 1ë¡œ í™•ì¸í•©ë‹ˆë‹¤. ì½œë“œìŠ¤íƒ€íŠ¸ ì‹œ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                ë„·ì§¸, shared.fashion_recommendations ìŠ¤í‚¤ë§ˆì— transactions, customers í…Œì´ë¸”ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
                ì´ì „ ë‹¨ê³„ê°€ ì‹¤íŒ¨í•˜ë©´ ì´í›„ ë‹¨ê³„ëŠ” ìë™ìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤. ëª¨ë‘ í†µê³¼í•˜ë©´ Exercise 01aë¡œ ì§„í–‰í•©ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Exercise 00: ì „ì²´ ì½”ë“œ (exercise_00_checklist.py) -->
        <section>
            <h2>Exercise 00 ì „ì²´ ì½”ë“œ</h2>
            <p style="font-size: 0.6em; color: var(--ev-text-muted);">exercise_00_checklist.py &mdash; ë³µì‚¬í•˜ì—¬ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥</p>
            <pre><code class="language-python" data-trim data-noescape style="font-size: 0.5em; line-height: 1.3;">
"""
Exercise 00: ì‚¬ì „ í™˜ê²½ ì²´í¬ë¦¬ìŠ¤íŠ¸
Genie MCP ì‹¤ìŠµ ì „ í™˜ê²½ ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ ê²€ì¦í•©ë‹ˆë‹¤.

ì‹¤í–‰: python exercise_00_checklist.py
"""

import configparser
import json
import os
import subprocess
import sys

import httpx
from dotenv import load_dotenv

load_dotenv()


def resolve_databricks_config() -&gt; tuple[str, str, str]:
    """Databricks ì¸ì¦ ì •ë³´ë¥¼ í•´ì„í•©ë‹ˆë‹¤. (.env â†’ databricks CLI â†’ ê¸°ë³¸ê°’)"""
    host = os.getenv("DATABRICKS_HOST", "").rstrip("/")
    token = os.getenv("DATABRICKS_TOKEN", "")
    warehouse_id = os.getenv("WAREHOUSE_ID", "")

    # databricks CLI fallback
    if not host or not token:
        try:
            cfg = configparser.ConfigParser()
            cfg.read(os.path.expanduser("~/.databrickscfg"))
            profile = cfg["DEFAULT"] if "DEFAULT" in cfg else {}
            if not host:
                host = profile.get("host", "").rstrip("/")
            if not token and host:
                result = subprocess.run(
                    ["databricks", "auth", "token", "--host", host],
                    capture_output=True,
                    text=True,
                    timeout=10,
                )
                if result.returncode == 0:
                    token = json.loads(result.stdout).get("access_token", "")
        except Exception:
            pass

    # ê¸°ë³¸ í˜¸ìŠ¤íŠ¸
    if not host:
        host = "https://e2-demo-field-eng.cloud.databricks.com"

    # Warehouse ìë™ ì¡°íšŒ
    if not warehouse_id and host and token:
        try:
            resp = httpx.get(
                f"{host}/api/2.0/sql/warehouses",
                headers={"Authorization": f"Bearer {token}"},
                timeout=10,
            )
            resp.raise_for_status()
            warehouses = resp.json().get("warehouses", [])
            for wh in warehouses:
                if wh.get("state") == "RUNNING":
                    warehouse_id = wh["id"]
                    break
            if not warehouse_id and warehouses:
                warehouse_id = warehouses[0]["id"]
        except Exception:
            pass

    return host, token, warehouse_id


DATABRICKS_HOST, DATABRICKS_TOKEN, WAREHOUSE_ID = resolve_databricks_config()

HTTP_TIMEOUT = 60.0
WAIT_TIMEOUT = "30s"


def mask_token(token: str) -&gt; str:
    """í† í°ì„ ë§ˆìŠ¤í‚¹í•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤. (ì˜ˆ: ****...abcd)"""
    if len(token) &lt;= 4:
        return "****"
    return f"****...{token[-4:]}"


# â”€â”€ Step 1: í™˜ê²½ë³€ìˆ˜ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


def check_auth_info() -&gt; tuple[bool, str]:
    """DATABRICKS_HOST, DATABRICKS_TOKEN, WAREHOUSE_ID ì¡´ì¬ë¥¼ í™•ì¸í•©ë‹ˆë‹¤."""
    missing = []
    if not DATABRICKS_HOST:
        missing.append("DATABRICKS_HOST")
    if not DATABRICKS_TOKEN:
        missing.append("DATABRICKS_TOKEN")
    if not WAREHOUSE_ID:
        missing.append("WAREHOUSE_ID")

    if missing:
        return False, (
            f"ëˆ„ë½: {', '.join(missing)}\n"
            "   â†’ .env íŒŒì¼ì„ í™•ì¸í•˜ê±°ë‚˜, databricks CLIë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”\n"
            "     (databricks configure)"
        )

    # ì¸ì¦ ì¶œì²˜ íŒë³„
    env_host = os.getenv("DATABRICKS_HOST", "")
    env_token = os.getenv("DATABRICKS_TOKEN", "")
    env_wh = os.getenv("WAREHOUSE_ID", "")

    if env_host and env_token:
        host_source = ".env"
    elif DATABRICKS_HOST == "https://e2-demo-field-eng.cloud.databricks.com" and not env_host:
        host_source = "ê¸°ë³¸ê°’"
    else:
        host_source = "databricks CLI"

    wh_source = ".env" if env_wh else "API ìë™ ì¡°íšŒ"

    lines = [
        f"DATABRICKS_HOST  = {DATABRICKS_HOST}",
        f"DATABRICKS_TOKEN = {mask_token(DATABRICKS_TOKEN)}",
        f"WAREHOUSE_ID     = {WAREHOUSE_ID}",
        f"ì¸ì¦ ì¶œì²˜: HOST/TOKEN={host_source}, WAREHOUSE={wh_source}",
    ]
    return True, "\n     ".join(lines)


# â”€â”€ Step 2: Databricks í˜¸ìŠ¤íŠ¸ ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


def check_host_connection() -&gt; tuple[bool, str]:
    """GET /api/2.0/clusters/spark-versions ë¡œ í˜¸ìŠ¤íŠ¸ ì—°ê²°ì„ í™•ì¸í•©ë‹ˆë‹¤."""
    headers = {
        "Authorization": f"Bearer {DATABRICKS_TOKEN}",
    }
    try:
        resp = httpx.get(
            f"{DATABRICKS_HOST}/api/2.0/clusters/spark-versions",
            headers=headers,
            timeout=HTTP_TIMEOUT,
        )
        resp.raise_for_status()
        return True, f"{DATABRICKS_HOST} ì—°ê²° ì„±ê³µ"
    except httpx.ConnectError:
        return False, f"í˜¸ìŠ¤íŠ¸ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {DATABRICKS_HOST}\n   â†’ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”"
    except httpx.HTTPStatusError as e:
        if e.response.status_code == 401:
            return False, "ì¸ì¦ ì‹¤íŒ¨ (401) â†’ DATABRICKS_TOKENì„ í™•ì¸í•´ì£¼ì„¸ìš”"
        if e.response.status_code == 403:
            return False, "ê¶Œí•œ ë¶€ì¡± (403) â†’ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”"
        return False, f"HTTP ì˜¤ë¥˜ {e.response.status_code}: {e.response.text[:200]}"
    except httpx.TimeoutException:
        return False, f"ì—°ê²° ì‹œê°„ ì´ˆê³¼ ({HTTP_TIMEOUT}s) â†’ ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"


# â”€â”€ Step 3: SQL Warehouse ì ‘ê·¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


def check_warehouse() -&gt; tuple[bool, str]:
    """POST /api/2.0/sql/statements ë¡œ SQL Warehouse ì ‘ê·¼ì„ í™•ì¸í•©ë‹ˆë‹¤."""
    headers = {
        "Authorization": f"Bearer {DATABRICKS_TOKEN}",
        "Content-Type": "application/json",
    }
    try:
        resp = httpx.post(
            f"{DATABRICKS_HOST}/api/2.0/sql/statements",
            headers=headers,
            json={
                "warehouse_id": WAREHOUSE_ID,
                "statement": "SELECT 1",
                "wait_timeout": WAIT_TIMEOUT,
            },
            timeout=HTTP_TIMEOUT,
        )
        resp.raise_for_status()
        data = resp.json()
        status = data.get("status", {}).get("state", "UNKNOWN")
        if status == "SUCCEEDED":
            return True, f"Warehouse {WAREHOUSE_ID} ì •ìƒ ì‘ë™"
        return False, f"ì¿¼ë¦¬ ìƒíƒœ: {status} â†’ Warehouseê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”"
    except httpx.HTTPStatusError as e:
        body = e.response.text[:300]
        if "RESOURCE_DOES_NOT_EXIST" in body or "does not exist" in body.lower():
            return False, f"Warehouseë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {WAREHOUSE_ID}\n   â†’ WAREHOUSE_IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"
        return False, f"HTTP ì˜¤ë¥˜ {e.response.status_code}: {body}"
    except httpx.TimeoutException:
        return False, f"ì¿¼ë¦¬ ì‹œê°„ ì´ˆê³¼ ({HTTP_TIMEOUT}s) â†’ Warehouse ì½œë“œìŠ¤íƒ€íŠ¸ ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”"


# â”€â”€ Step 4: ë°ì´í„° ìŠ¤í‚¤ë§ˆ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


def check_schema() -&gt; tuple[bool, str]:
    """shared.fashion_recommendations ìŠ¤í‚¤ë§ˆì— í•„ìš”í•œ í…Œì´ë¸”ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."""
    headers = {
        "Authorization": f"Bearer {DATABRICKS_TOKEN}",
        "Content-Type": "application/json",
    }
    required_tables = {"transactions", "customers"}

    try:
        resp = httpx.post(
            f"{DATABRICKS_HOST}/api/2.0/sql/statements",
            headers=headers,
            json={
                "warehouse_id": WAREHOUSE_ID,
                "statement": "SHOW TABLES IN shared.fashion_recommendations",
                "wait_timeout": WAIT_TIMEOUT,
            },
            timeout=HTTP_TIMEOUT,
        )
        resp.raise_for_status()
        data = resp.json()
        status = data.get("status", {}).get("state", "UNKNOWN")

        if status != "SUCCEEDED":
            return False, f"ì¿¼ë¦¬ ìƒíƒœ: {status} â†’ shared.fashion_recommendations ìŠ¤í‚¤ë§ˆ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”"

        # ê²°ê³¼ì—ì„œ í…Œì´ë¸”ëª… ì¶”ì¶œ
        columns = [col["name"] for col in data.get("manifest", {}).get("schema", {}).get("columns", [])]
        table_name_idx = columns.index("tableName") if "tableName" in columns else 0

        found_tables = set()
        for row in data.get("result", {}).get("data_array", []):
            found_tables.add(row[table_name_idx])

        missing = required_tables - found_tables
        if missing:
            return False, f"ëˆ„ë½ëœ í…Œì´ë¸”: {', '.join(sorted(missing))}\n   â†’ shared.fashion_recommendations ìŠ¤í‚¤ë§ˆì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”"

        return True, f"í…Œì´ë¸” í™•ì¸ ì™„ë£Œ: {', '.join(sorted(required_tables))}"

    except httpx.HTTPStatusError as e:
        body = e.response.text[:300]
        if "SCHEMA_NOT_FOUND" in body or "not found" in body.lower():
            return False, "ìŠ¤í‚¤ë§ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: shared.fashion_recommendations\n   â†’ ì¹´íƒˆë¡œê·¸/ìŠ¤í‚¤ë§ˆ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”"
        return False, f"HTTP ì˜¤ë¥˜ {e.response.status_code}: {body}"
    except httpx.TimeoutException:
        return False, f"ì¿¼ë¦¬ ì‹œê°„ ì´ˆê³¼ ({HTTP_TIMEOUT}s) â†’ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”"


# â”€â”€ ë©”ì¸ ì‹¤í–‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


STEPS: list[tuple[str, callable]] = [
    ("ì¸ì¦ ì •ë³´ í™•ì¸", check_auth_info),
    ("Databricks í˜¸ìŠ¤íŠ¸ ì—°ê²°", check_host_connection),
    ("SQL Warehouse ì ‘ê·¼", check_warehouse),
    ("ë°ì´í„° ìŠ¤í‚¤ë§ˆ í™•ì¸", check_schema),
]


def main():
    print("ğŸ” Exercise 00: Genie MCP ì‚¬ì „ í™˜ê²½ ì²´í¬ë¦¬ìŠ¤íŠ¸")
    print("=" * 60)

    all_passed = True

    for i, (label, check_fn) in enumerate(STEPS, 1):
        print(f"\n  {i}ï¸âƒ£  {label}...")

        if not all_passed:
            print(f"     â­ï¸  ê±´ë„ˆëœ€ (ì´ì „ ë‹¨ê³„ ì‹¤íŒ¨)")
            continue

        ok, message = check_fn()
        if ok:
            print(f"     âœ… {message}")
        else:
            print(f"     âŒ {message}")
            all_passed = False

    print("\n" + "=" * 60)
    if all_passed:
        print("âœ… ëª¨ë“  í™˜ê²½ ì„¤ì •ì´ ì •ìƒì…ë‹ˆë‹¤!")
        print(f"   Warehouse ID: {WAREHOUSE_ID}")
        print(f"\nğŸ’¡ ë‹¤ìŒ ë‹¨ê³„: exercise_01aë¡œ Genie Spaceë¥¼ ìƒì„±í•˜ì„¸ìš”")
        print(f"   python exercise_01a_create_space.py")
    else:
        print("âŒ í™˜ê²½ ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ìœ„ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
        sys.exit(1)


if __name__ == "__main__":
    main()
            </code></pre>
            <aside class="notes">
                Exercise 00ì˜ ì „ì²´ ì½”ë“œì…ë‹ˆë‹¤. Copy ë²„íŠ¼ìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                í•˜ì´ë¼ì´íŠ¸ëœ êµ¬ê°„ì„ í™•ì¸í•´ë³´ì„¸ìš”:
                ì²« ë²ˆì§¸ â€” importì™€ load_dotenv (1-15í–‰) â€” configparser, subprocess ë“± ì¸ë¼ì¸ ì¸ì¦ì— í•„ìš”í•œ ëª¨ë“ˆ í¬í•¨
                ë‘ ë²ˆì§¸ â€” resolve_databricks_config (18-70í–‰) â€” .env â†’ CLI â†’ ê¸°ë³¸ê°’ ìˆœì„œë¡œ HOST/TOKEN/WAREHOUSE_ID í•´ì„
                ì„¸ ë²ˆì§¸ â€” ì¸ì¦ í•´ì„ ì‹¤í–‰ (72-73í–‰) â€” 3ê°œ ê°’ì„ í•œ ë²ˆì— ë°›ì•„ ëª¨ë“ˆ ìˆ˜ì¤€ ë³€ìˆ˜ë¡œ ì„¤ì •
                ë„¤ ë²ˆì§¸ â€” mask_tokenê³¼ check_auth_info (82-121í–‰) â€” í† í° ë§ˆìŠ¤í‚¹ + ì¸ì¦ ì¶œì²˜(.env/CLI/ê¸°ë³¸ê°’/API ìë™ ì¡°íšŒ) í‘œì‹œ
                ë‹¤ì„¯ ë²ˆì§¸ â€” check_host_connection (127-149í–‰) â€” ê²½ëŸ‰ read-only ì—”ë“œí¬ì¸íŠ¸ë¡œ í˜¸ìŠ¤íŠ¸ ì—°ê²°ê³¼ í† í° ìœ íš¨ì„±ì„ ë™ì‹œì— ê²€ì¦
                ì—¬ì„¯ ë²ˆì§¸ â€” check_warehouse + check_schema (155-196í–‰) â€” SELECT 1ê³¼ SHOW TABLESë¡œ Warehouse/ìŠ¤í‚¤ë§ˆ í™•ì¸
                ì¼ê³± ë²ˆì§¸ â€” main í•¨ìˆ˜ (202-258í–‰) â€” cascading skip íŒ¨í„´ìœ¼ë¡œ ì´ì „ ë‹¨ê³„ ì‹¤íŒ¨ ì‹œ ì´í›„ ë‹¨ê³„ë¥¼ ê±´ë„ˆëœ€
            </aside>
        </section>

        <!-- ============================================================ -->
        <!-- Exercise 01a: Genie Space ìƒì„± (Slides 7-11) -->
        <!-- ============================================================ -->

        <!-- Slide 7: serialized_space JSON êµ¬ì¡° -->
        <section>
            <h2>serialized_space JSON êµ¬ì¡°</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);">Space ìƒì„± APIì— ì „ë‹¬í•˜ëŠ” protobuf v2 JSON í˜•ì‹ì˜ ëª©í‘œ ì¶œë ¥</p>
            <pre><code class="language-json" data-trim data-noescape style="font-size: 0.8em; line-height: 1.4;">
{
  "version": 2,
  "data_sources": {
    "tables": [{"identifier": "catalog.schema.table"}]
  },
  "config": {
    "sample_questions": [{"id": "...", "question": ["ì§ˆë¬¸ í…ìŠ¤íŠ¸"]}]
  },
  "instructions": {
    "text_instructions": [
      {"id": "...", "content": ["ì§€ì‹œì‚¬í•­ í…ìŠ¤íŠ¸"]}
    ],
    "example_question_sqls": [
      {"id": "...", "question": ["ì§ˆë¬¸"], "sql": ["SELECT ..."]}
    ],
    "join_specs": [ ... ],
    "sql_snippets": { "expressions": [...], "measures": [...], "filters": [...] }
  }
}
            </code></pre>
            <div class="emphasis-box fragment" style="margin-top: 0.8em;">
                ì´ êµ¬ì¡°ë¥¼ ì½”ë“œë¡œ ìƒì„±í•©ë‹ˆë‹¤ &mdash; <code>build_serialized_space()</code>
            </div>
            <aside class="notes">
                ì´ê²ƒì´ Genie Space ìƒì„± APIì— ì „ë‹¬í•˜ëŠ” serialized_spaceì˜ ì „ì²´ JSON êµ¬ì¡°ì…ë‹ˆë‹¤.
                version 2ëŠ” protobuf v2 í˜•ì‹ì„ ì˜ë¯¸í•˜ë©°, Databricks ë‚´ë¶€ í”„ë¡œí† ì½œì…ë‹ˆë‹¤.
                data_sourcesì—ëŠ” í…Œì´ë¸” ì •ë³´, configì—ëŠ” ì˜ˆì œ ì§ˆë¬¸, instructionsì—ëŠ” ì§€ì‹œì‚¬í•­ê³¼ ì˜ˆì œ SQLì„ ë‹´ìŠµë‹ˆë‹¤.
                join_specsì™€ sql_snippetsëŠ” ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ë³µì¡í•œ ë°ì´í„° ëª¨ë¸ì—ì„œ Genieì˜ SQL í’ˆì§ˆì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.
                ì´ì œ ì´ êµ¬ì¡°ë¥¼ ìƒì„±í•˜ëŠ” ì½”ë“œë¥¼ ë‹¨ê³„ë³„ë¡œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 7.5: JSON â†’ Genie Space UI ë§¤í•‘ -->
        <section>
            <h2>JSON â†’ Genie Space UI ë§¤í•‘</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);">
                serialized_space JSONì˜ ê° í•„ë“œê°€ Genie Space UIì— ì–´ë–»ê²Œ ë°˜ì˜ë˜ëŠ”ì§€ í™•ì¸
            </p>
            <div style="display: flex; gap: 1em; justify-content: center; align-items: flex-start; margin-top: 0.5em;">
                <!-- Data íƒ­ -->
                <div style="flex: 1; text-align: center;">
                    <img src="images/genie_data.png" alt="Genie Data Tab" style="max-height: 350px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.55em; color: var(--ev-accent); margin-top: 0.4em;">
                        <code>data_sources.tables</code>
                    </p>
                </div>
                <!-- Instructions íƒ­ -->
                <div style="flex: 1; text-align: center;">
                    <img src="images/genie_instructions.png" alt="Genie Instructions Tab" style="max-height: 350px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.55em; color: var(--ev-accent); margin-top: 0.4em;">
                        <code>instructions</code>
                    </p>
                </div>
                <!-- Settings íƒ­ -->
                <div style="flex: 1; text-align: center;">
                    <img src="images/genie_settings.png" alt="Genie Settings Tab" style="max-height: 350px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                    <p style="font-size: 0.55em; color: var(--ev-accent); margin-top: 0.4em;">
                        <code>config</code> + title
                    </p>
                </div>
            </div>
            <aside class="notes">
                ì•ì„œ ë³¸ JSON êµ¬ì¡°ê°€ ì‹¤ì œ Genie Space UIì— ì–´ë–»ê²Œ ë°˜ì˜ë˜ëŠ”ì§€ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•´ë´…ì‹œë‹¤.
                Data íƒ­ì—ëŠ” data_sources.tablesì— ì •ì˜í•œ í…Œì´ë¸”ë“¤ì´ í‘œì‹œë©ë‹ˆë‹¤.
                Instructions íƒ­ì—ëŠ” text_instructions, example_question_sqls, join_specs, sql_snippets ë“±ì´ ë°˜ì˜ë©ë‹ˆë‹¤.
                Settings íƒ­ì—ëŠ” config.sample_questionsë¡œ ì„¤ì •í•œ ì˜ˆì œ ì§ˆë¬¸ë“¤ê³¼ title, descriptionì´ í‘œì‹œë©ë‹ˆë‹¤.
                ì´ë ‡ê²Œ ì½”ë“œì—ì„œ ì •ì˜í•œ JSONì´ UIì˜ ê° íƒ­ì— 1:1ë¡œ ë§¤í•‘ë˜ë¯€ë¡œ, ì½”ë“œë§Œìœ¼ë¡œ Genie Spaceë¥¼ ì™„ì „íˆ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 8: Step 1 â€” Space ì„¤ì • ë°ì´í„° -->
        <section>
            <h2>Step 1: Space ì„¤ì • ë°ì´í„°</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);">í…Œì´ë¸”, ì§€ì‹œì‚¬í•­, ì˜ˆì œ ì§ˆë¬¸/SQL, SQL ìŠ¤ë‹ˆí« ì •ì˜</p>
            <pre><code class="language-python" data-trim data-noescape style="font-size: 0.8em; line-height: 1.4;">
tables = [
    {"catalog": "jongseob_demo", "schema": "fashion_recommendations", "table": "transactions"},
    {"catalog": "jongseob_demo", "schema": "fashion_recommendations", "table": "customers"},
]
instructions = [
    "## Sales Channel Mapping\n- `sales_channel_id = 1` means **Online** ...",
    # ...
]
sample_questions = [
    "How does revenue compare between online and in-store sales by month?",
    "What is the total online revenue for 2020?",
    "What are the monthly sales trends?",
    # ...
]
example_sqls = [
    {
        "question": "How does revenue compare between online and in-store sales by month?",
        "sql": "SELECT year, month, CASE WHEN ... FROM ...transactions GROUP BY ...",
    },
    # ...
]
sql_snippets = {
    "filters": [
        {
            "id": uuid4().hex,
            "sql": "transactions.sales_channel_id = 1",
            "display_name": "Online Sales Only",
            "synonyms": ["online", "web sales"]
        },
        # ...
    ],
    "expressions": [
        {
            "id": uuid4().hex,
            "alias": "transaction_month",
            "sql": "transactions.month",
            "display_name": "Transaction Month",
            "synonyms": ["month", "sale month"]
        },
        # ...
    ],
    "measures": [
        {
            "id": uuid4().hex,
            "alias": "total_revenue",
            "sql": "CAST(SUM(transactions.price) AS DECIMAL(38,2))",
            "display_name": "Total Revenue",
            "synonyms": ["revenue", "total sales"]
        },
        # ...
    ]
}
            </code></pre>
            <aside class="notes">
                ë¨¼ì € Spaceì— ë„£ì„ ì„¤ì • ë°ì´í„°ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
                tablesëŠ” Genieê°€ ì§ˆì˜í•  í…Œì´ë¸” ëª©ë¡ì…ë‹ˆë‹¤. fashion_recommendations ìŠ¤í‚¤ë§ˆì˜ transactions, customers 2ê°œ í…Œì´ë¸”ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                instructionsëŠ” Genieì—ê²Œ ì£¼ëŠ” ì§€ì‹œì‚¬í•­ì…ë‹ˆë‹¤ â€” ì»¬ëŸ¼ ë„¤ì´ë°, ë‚ ì§œ ì²˜ë¦¬, ì±„ë„ ë§¤í•‘, ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ ê°€ì´ë“œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
                sample_questionsëŠ” 5ê°œì˜ ì˜ˆì œ ì§ˆë¬¸, example_sqlsëŠ” 3ê°œì˜ ì§ˆë¬¸-SQL ìŒì…ë‹ˆë‹¤.
                sql_snippetsëŠ” í•„í„° 5ê°œ, í‘œí˜„ì‹ 3ê°œ, ì¸¡ì •ê°’ 4ê°œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
                ìŠ¬ë¼ì´ë“œì—ì„œëŠ” ìš”ì•½ í‘œì‹œí•˜ì§€ë§Œ, ì „ì²´ ì½”ë“œëŠ” exercise_01a_create_space.pyì— ìˆìŠµë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 9: Step 2 â€” build_serialized_space() -->
        <section>
            <h2>Step 2: build_serialized_space()</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);">ì„¤ì • ë°ì´í„°ë¥¼ protobuf v2 JSONìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜</p>
            <pre><code class="language-python" data-trim data-noescape style="font-size: 0.8em; line-height: 1.4;">
def build_serialized_space(
    tables: list[dict],
    instructions: list[str],
    sample_questions: list[str],
    example_sqls: list[dict],
    join_specs: list[dict] | None = None,
    sql_snippets: dict | None = None,
) -> str:
    """Genie Spaceìš© serialized_space(protobuf v2 JSON)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    inst_block: dict = {
        "text_instructions": [
            {"id": uuid4().hex, "content": [inst]} for inst in instructions
        ],
        "example_question_sqls": [
            {
                "id": uuid4().hex,
                "question": [ex["question"]],
                "sql": [ex["sql"]],
            }
            for ex in example_sqls
        ],
    }

    if join_specs:
        inst_block["join_specs"] = join_specs

    if sql_snippets:
        inst_block["sql_snippets"] = sql_snippets

    proto = {
        "version": 2,
        "data_sources": {
            "tables": [
                {"identifier": f"{t['catalog']}.{t['schema']}.{t['table']}"}
                for t in tables
            ]
        },
        "config": {
            "sample_questions": [
                {"id": uuid4().hex, "question": [q]} for q in sample_questions
            ]
        },
        "instructions": inst_block,
    }
    return json.dumps(proto)
            </code></pre>
            <aside class="notes">
                build_serialized_space í•¨ìˆ˜ëŠ” ì•ì—ì„œ ì •ì˜í•œ ì„¤ì • ë°ì´í„°ë¥¼ Genie APIê°€ ìš”êµ¬í•˜ëŠ” protobuf v2 JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                text_instructionsì™€ example_question_sqlsì—ëŠ” ê°ê° ê³ ìœ  UUIDë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
                join_specsì™€ sql_snippetsëŠ” ì„ íƒ ì‚¬í•­ì´ë¯€ë¡œ ìˆì„ ë•Œë§Œ í¬í•¨í•©ë‹ˆë‹¤.
                ìµœì¢…ì ìœ¼ë¡œ json.dumpsë¡œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ APIì— ì „ë‹¬í•  ì¤€ë¹„ë¥¼ í•©ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 10: Step 3 â€” Space ìƒì„± API í•¨ìˆ˜ -->
        <section>
            <h2>Step 3: create_genie_space()</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);">POST /api/2.0/genie/spacesë¡œ Spaceë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜</p>
            <pre><code class="language-python" data-trim data-noescape style="font-size: 0.8em; line-height: 1.4;">
def create_genie_space(
    title: str, description: str, warehouse_id: str, serialized_space: str,
) -> dict:
    """POST /api/2.0/genie/spacesë¡œ Spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    resp = httpx.post(
        f"{DATABRICKS_HOST}/api/2.0/genie/spaces",
        headers=headers,
        json={
            "title": title, "description": description,
            "warehouse_id": warehouse_id, "serialized_space": serialized_space,
        },
    )
    resp.raise_for_status()
    return resp.json()
            </code></pre>
            <div class="emphasis-box fragment" style="margin-top: 1em;">
                <strong>í•µì‹¬:</strong> <code>serialized_space</code>ë¥¼ ë¬¸ìì—´ë¡œ ì „ë‹¬ &mdash; JSON ì•ˆì— JSON ë¬¸ìì—´
            </div>
            <aside class="notes">
                create_genie_space í•¨ìˆ˜ëŠ” POST /genie/spaces ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
                titleê³¼ descriptionì€ Spaceì˜ ë©”íƒ€ì •ë³´ì´ê³ ,
                warehouse_idëŠ” ì¿¼ë¦¬ ì‹¤í–‰ì— ì‚¬ìš©í•  SQL Warehouseì…ë‹ˆë‹¤.
                serialized_spaceëŠ” ì•ì„œ build_serialized_spaceë¡œ ìƒì„±í•œ JSON ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
                ì£¼ì˜í•  ì ì€ serialized_spaceê°€ JSON ì•ˆì— ë¬¸ìì—´ë¡œ ë“¤ì–´ê°„ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤ â€” JSON ì•ˆì— JSON ë¬¸ìì—´ì…ë‹ˆë‹¤.
                ë‹¤ìŒ ìŠ¬ë¼ì´ë“œì—ì„œ main í•¨ìˆ˜ì˜ ì‹¤í–‰ íë¦„ì„ ë³´ê² ìŠµë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 11: Exercise 01a ì „ì²´ ì½”ë“œ -->
        <section>
            <h2>Exercise 01a ì „ì²´ ì½”ë“œ</h2>
            <p style="font-size: 0.6em; color: var(--ev-text-muted);">exercise_01a_create_space.py &mdash; ë³µì‚¬í•˜ì—¬ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥</p>
            <pre><code class="language-python" style="font-size: 0.5em; line-height: 1.3;">
"""
Exercise 01a: Genie Space ìƒì„±
Databricks Genie Spaceë¥¼ APIë¡œ ìƒì„±í•©ë‹ˆë‹¤.

ì‹¤í–‰: python exercise_01a_create_space.py
"""

import json
import os
from uuid import uuid4

import httpx
from dotenv import load_dotenv

load_dotenv()

DATABRICKS_HOST = os.getenv("DATABRICKS_HOST", "").rstrip("/")
DATABRICKS_TOKEN = os.getenv("DATABRICKS_TOKEN", "")
WAREHOUSE_ID = os.getenv("WAREHOUSE_ID", "")

if not all([DATABRICKS_HOST, DATABRICKS_TOKEN, WAREHOUSE_ID]):
    print("âš ï¸  .env íŒŒì¼ì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")
    print("   cp .env.example .env í›„ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.")
    print("   í•„ìš”: DATABRICKS_HOST, DATABRICKS_TOKEN, WAREHOUSE_ID")
    exit(1)

headers = {
    "Authorization": f"Bearer {DATABRICKS_TOKEN}",
    "Content-Type": "application/json",
}


def build_serialized_space(
    tables: list[dict],
    instructions: list[str],
    sample_questions: list[str],
    example_sqls: list[dict],
    join_specs: list[dict] | None = None,
    sql_snippets: dict | None = None,
) -> str:
    """Genie Spaceìš© serialized_space(protobuf v2 JSON)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    # ğŸ’¡ í•™ìŠµ í¬ì¸íŠ¸: Databricks ë‚´ë¶€ì ìœ¼ë¡œ protobuf v2 JSON í˜•ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤
    inst_block: dict = {
        "text_instructions": [
            {"id": uuid4().hex, "content": [inst]} for inst in instructions
        ],
        "example_question_sqls": [
            {
                "id": uuid4().hex,
                "question": [ex["question"]],
                "sql": [ex["sql"]],
            }
            for ex in example_sqls
        ],
    }

    # ğŸ’¡ join_specs: í…Œì´ë¸” ê°„ ì¡°ì¸ ê´€ê³„ë¥¼ ëª…ì‹œí•˜ì—¬ Genieê°€ ì •í™•í•œ JOIN SQLì„ ìƒì„±í•˜ë„ë¡ ìœ ë„
    if join_specs:
        inst_block["join_specs"] = join_specs

    # ğŸ’¡ sql_snippets: ìì£¼ ì“°ëŠ” ê³„ì‚°ì‹/ì§‘ê³„/í•„í„°ë¥¼ ë¯¸ë¦¬ ì •ì˜í•˜ì—¬ ì¼ê´€ëœ SQL ìƒì„± ìœ ë„
    if sql_snippets:
        inst_block["sql_snippets"] = sql_snippets

    proto = {
        "version": 2,
        "data_sources": {
            "tables": [
                {"identifier": f"{t['catalog']}.{t['schema']}.{t['table']}"}
                for t in tables
            ]
        },
        "config": {
            "sample_questions": [
                {"id": uuid4().hex, "question": [q]} for q in sample_questions
            ]
        },
        "instructions": inst_block,
    }
    return json.dumps(proto)


def create_genie_space(
    title: str,
    description: str,
    warehouse_id: str,
    serialized_space: str,
) -> dict:
    """POST /api/2.0/genie/spacesë¡œ Spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    resp = httpx.post(
        f"{DATABRICKS_HOST}/api/2.0/genie/spaces",
        headers=headers,
        json={
            "title": title,
            "description": description,
            "warehouse_id": warehouse_id,
            "serialized_space": serialized_space,
        },
    )
    resp.raise_for_status()
    return resp.json()


def main():
    print("ğŸ§ Exercise 01a: Genie Space ìƒì„±")
    print("=" * 60)

    # ì˜ˆì œ ì„¤ì • â€” Fashion Recommendations ë°ì´í„°
    tables = [
        {"catalog": "jongseob_demo", "schema": "fashion_recommendations", "table": "transactions"},
        {"catalog": "jongseob_demo", "schema": "fashion_recommendations", "table": "customers"},
    ]
    instructions = [
        "## Column Naming Conventions\n"
        "- The transaction date column is `t_dat` in the `transactions` table, not `date` or `transaction_date`.\n"
        "- Customer identifier is `customer_id` in both `transactions` and `customers` tables.\n"
        "- The `price` column in `transactions` represents per-unit price â€” each row is one unit sold.",
        "## Date and Time Handling\n"
        "- Use `t_dat` for date filtering in the `transactions` table (format: DATE).\n"
        "- The `transactions` table has pre-extracted `year` and `month` integer columns â€” prefer these for year/month grouping over YEAR() and MONTH() functions.\n"
        "- When users say 'last month' or 'this year', use CURRENT_DATE and DATE_SUB/DATE_TRUNC functions on `t_dat`.",
        "## Sales Channel Mapping\n"
        "- `sales_channel_id = 1` means **Online** sales.\n"
        "- `sales_channel_id = 2` means **In-Store** (offline) sales.\n"
        "- When users ask about 'online sales' or 'store sales', filter on `sales_channel_id` accordingly.",
        "## Customer Segmentation\n"
        "- `club_member_status` in the `customers` table indicates membership tier (ACTIVE, PRE-CREATE, LEFT CLUB, etc.).\n"
        "- `fashion_news_frequency` indicates news subscription (Regularly, Monthly, None).\n"
        "- Use `customers.age` for age-based segmentation.",
    ]
    sample_questions = [
        "How does revenue compare between online and in-store sales by month?",
        "What is the total online revenue for 2020?",
        "What are the monthly sales trends?",
        "Who are the top spending customers and what is their membership status?",
        "How many transactions did each age group make?",
    ]
    example_sqls = [
        {
            "question": "How does revenue compare between online and in-store sales by month?",
            "sql": "SELECT year, month, CASE WHEN sales_channel_id = 1 THEN 'Online' ELSE 'In-Store' END AS sales_channel, COUNT(*) AS num_transactions, CAST(SUM(price) AS DECIMAL(38,2)) AS total_revenue FROM jongseob_demo.fashion_recommendations.transactions GROUP BY year, month, sales_channel_id ORDER BY year, month, sales_channel_id",
        },
        {
            "question": "What are the monthly sales trends?",
            "sql": "SELECT year, month, COUNT(*) AS num_transactions, CAST(SUM(price) AS DECIMAL(38,2)) AS total_revenue, COUNT(DISTINCT customer_id) AS unique_customers FROM jongseob_demo.fashion_recommendations.transactions GROUP BY year, month ORDER BY year, month",
        },
        {
            "question": "Who are the top spending customers and what is their membership status?",
            "sql": "SELECT t.customer_id, c.club_member_status, c.age, COUNT(*) AS num_purchases, CAST(SUM(t.price) AS DECIMAL(38,2)) AS total_spent FROM jongseob_demo.fashion_recommendations.transactions t INNER JOIN jongseob_demo.fashion_recommendations.customers c ON t.customer_id = c.customer_id GROUP BY t.customer_id, c.club_member_status, c.age ORDER BY total_spent DESC LIMIT 20",
        },
    ]

    # ğŸ’¡ join_specs: transactions â†” customers ì¡°ì¸ ì¡°ê±´ì„ ëª…ì‹œí•©ë‹ˆë‹¤
    join_specs = [
        {
            "left": {"table": "jongseob_demo.fashion_recommendations.transactions", "column": "customer_id"},
            "right": {"table": "jongseob_demo.fashion_recommendations.customers", "column": "customer_id"},
            "sql": ["jongseob_demo.fashion_recommendations.transactions.customer_id = jongseob_demo.fashion_recommendations.customers.customer_id"],
        }
    ]

    # ğŸ’¡ sql_snippets: ìì£¼ ì“°ëŠ” ê³„ì‚°ì‹/ì§‘ê³„/í•„í„°ë¥¼ ë¯¸ë¦¬ ì •ì˜í•©ë‹ˆë‹¤
    sql_snippets = {
        "filters": [
            {
                "id": uuid4().hex,
                "sql": "transactions.sales_channel_id = 1",
                "display_name": "Online Sales Only",
                "synonyms": ["online", "web sales", "e-commerce"],
            },
            {
                "id": uuid4().hex,
                "sql": "customers.club_member_status = 'ACTIVE'",
                "display_name": "Active Club Members",
                "synonyms": ["active members", "club members", "active customers"],
            },
            {
                "id": uuid4().hex,
                "sql": "transactions.t_dat >= DATE_SUB(CURRENT_DATE(), 365)",
                "display_name": "Last 12 Months",
                "synonyms": ["last year", "past year", "recent year"],
            },
            {
                "id": uuid4().hex,
                "sql": "transactions.sales_channel_id = 2",
                "display_name": "In-Store Sales Only",
                "synonyms": ["in-store", "offline", "store sales", "brick and mortar"],
            },
            {
                "id": uuid4().hex,
                "sql": "transactions.t_dat >= DATE_SUB(CURRENT_DATE(), 30)",
                "display_name": "Last 30 Days",
                "synonyms": ["last month", "recent", "past month"],
            },
        ],
        "expressions": [
            {
                "id": uuid4().hex,
                "alias": "transaction_month",
                "sql": "transactions.month",
                "display_name": "Transaction Month",
                "synonyms": ["month", "sale month"],
            },
            {
                "id": uuid4().hex,
                "alias": "sales_channel_name",
                "sql": "CASE WHEN transactions.sales_channel_id = 1 THEN 'Online' ELSE 'In-Store' END",
                "display_name": "Sales Channel Name",
                "synonyms": ["channel", "sales channel"],
            },
            {
                "id": uuid4().hex,
                "alias": "transaction_year",
                "sql": "transactions.year",
                "display_name": "Transaction Year",
                "synonyms": ["year", "sale year"],
            },
        ],
        "measures": [
            {
                "id": uuid4().hex,
                "alias": "transaction_count",
                "sql": "COUNT(*)",
                "display_name": "Transaction Count",
                "synonyms": ["number of transactions", "sales count", "purchase count"],
            },
            {
                "id": uuid4().hex,
                "alias": "unique_customer_count",
                "sql": "COUNT(DISTINCT transactions.customer_id)",
                "display_name": "Unique Customers",
                "synonyms": ["customer count", "distinct customers", "number of customers"],
            },
            {
                "id": uuid4().hex,
                "alias": "avg_price",
                "sql": "CAST(AVG(transactions.price) AS DECIMAL(38,2))",
                "display_name": "Average Price",
                "synonyms": ["avg price", "mean price", "average transaction value"],
            },
            {
                "id": uuid4().hex,
                "alias": "total_revenue",
                "sql": "CAST(SUM(transactions.price) AS DECIMAL(38,2))",
                "display_name": "Total Revenue",
                "synonyms": ["revenue", "total sales", "sales amount"],
            },
        ],
    }

    print("  1ï¸âƒ£ serialized_space ìƒì„± ì¤‘...")
    serialized = build_serialized_space(
        tables=tables,
        instructions=instructions,
        sample_questions=sample_questions,
        example_sqls=example_sqls,
        join_specs=join_specs,
        sql_snippets=sql_snippets,
    )
    print(f"  âœ… serialized_space ìƒì„± ì™„ë£Œ ({len(serialized)} bytes)")

    print("  2ï¸âƒ£ Genie Space ìƒì„± API í˜¸ì¶œ ì¤‘...")
    space = create_genie_space(
        title="Fashion Recommendations Analytics 2",
        description="A natural language analytics space for exploring fashion sales transactions and customer profiles.",
        warehouse_id=WAREHOUSE_ID,
        serialized_space=serialized,
    )
    space_id = space["space_id"]
    print(f"  âœ… Space ìƒì„± ì™„ë£Œ!")
    print(f"     Space ID: {space_id}")

    print(f"\nğŸ’¡ Tip: exercise_01bì—ì„œ ì´ Space IDë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:")
    print(f"   python exercise_01b_query_space.py {space_id}")


if __name__ == "__main__":
    main()
            </code></pre>
            <aside class="notes">
                Exercise 01aì˜ ì „ì²´ ì½”ë“œì…ë‹ˆë‹¤. Copy ë²„íŠ¼ìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                í•˜ì´ë¼ì´íŠ¸ëœ êµ¬ê°„ì„ í™•ì¸í•´ë³´ì„¸ìš”:
                ì²« ë²ˆì§¸ â€” importì™€ í™˜ê²½ë³€ìˆ˜ ì„¤ì • (1-14í–‰)
                ë‘ ë²ˆì§¸ â€” build_serialized_space í•¨ìˆ˜ (34-97í–‰)
                ì„¸ ë²ˆì§¸ â€” create_genie_space í•¨ìˆ˜ (100-114í–‰)
                ë„¤ ë²ˆì§¸ â€” main í•¨ìˆ˜ (117-257í–‰) â€” Fashion Recommendations 2ê°œ í…Œì´ë¸”, 4ê°œ instructions, 5ê°œ ì˜ˆì œ ì§ˆë¬¸, 3ê°œ ì˜ˆì œ SQL, join_specs, sql_snippets í¬í•¨
                .env íŒŒì¼ì— DATABRICKS_HOST, DATABRICKS_TOKEN, WAREHOUSE_IDë¥¼ ì„¤ì •í•œ í›„ ì‹¤í–‰í•˜ì„¸ìš”.
                ì¶œë ¥ëœ Space IDë¥¼ exercise_01bì—ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- ============================================================ -->
        <!-- Exercise 01b: Genie Space ì§ˆì˜ (Slides 12-14) -->
        <!-- ============================================================ -->

        <!-- Slide 12: ì§ˆì˜ API í•¨ìˆ˜ -->
        <section>
            <h2>Exercise 01b: ì§ˆì˜ API í•¨ìˆ˜</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);">create_conversation, send_message, poll_result, format_result</p>
            <pre><code class="language-python" data-trim data-noescape style="font-size: 0.48em; line-height: 1.4;">
def create_conversation(space_id: str) -> str:
    """ìƒˆ Genie ëŒ€í™”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    resp = httpx.post(f"{base_url}/conversations", headers=headers)
    resp.raise_for_status()
    return resp.json()["conversation_id"]


def send_message(space_id: str, conversation_id: str, question: str) -> dict:
    """Genieì— ìì—°ì–´ ì§ˆë¬¸ì„ ë³´ëƒ…ë‹ˆë‹¤."""
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    resp = httpx.post(
        f"{base_url}/conversations/{conversation_id}/messages",
        headers=headers, json={"content": question},
    )
    resp.raise_for_status()
    return resp.json()


def poll_result(
    space_id: str, conversation_id: str, message_id: str, max_wait: int = 120,
) -> dict:
    """ê²°ê³¼ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ì ì§„ì  ë°±ì˜¤í”„ë¡œ í´ë§í•©ë‹ˆë‹¤."""
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    url = f"{base_url}/conversations/{conversation_id}/messages/{message_id}"

    start = time.time()
    interval = 1.0
    while time.time() - start < max_wait:
        resp = httpx.get(url, headers=headers)
        resp.raise_for_status()
        data = resp.json()
        status = data.get("status", "")
        if status == "COMPLETED":
            return data
        if status in ("FAILED", "CANCELLED"):
            raise RuntimeError(f"Genie ì§ˆì˜ ì‹¤íŒ¨: {status}")
        elapsed = time.time() - start
        print(f"  â³ ìƒíƒœ: {status} ({elapsed:.0f}ì´ˆ ê²½ê³¼)")
        time.sleep(interval)
        interval = min(interval * 1.5, 5.0)

    raise TimeoutError("Genie ì‘ë‹µ ì‹œê°„ ì´ˆê³¼")


def format_result(data: dict) -> str:
    """ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸/SQL ê²°ê³¼ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤."""
    attachments = data.get("attachments", [])
    parts = []
    for att in attachments:
        if "text" in att:
            parts.append(att["text"].get("content", ""))
        if "query" in att:
            parts.append(f"SQL: {att['query'].get('query', '')}")
    return "\n".join(parts) if parts else json.dumps(data, indent=2, ensure_ascii=False)
            </code></pre>
            <aside class="notes">
                Exercise 01bì˜ 4ê°œ í•µì‹¬ í•¨ìˆ˜ì…ë‹ˆë‹¤.
                create_conversationì€ ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ê³  conversation_idë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
                send_messageëŠ” ìì—°ì–´ ì§ˆë¬¸ì„ ë³´ë‚´ê³  message_idë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
                poll_resultëŠ” ì ì§„ì  ë°±ì˜¤í”„ë¡œ ê²°ê³¼ë¥¼ í´ë§í•©ë‹ˆë‹¤ â€” 1ì´ˆì—ì„œ ì‹œì‘í•˜ì—¬ 1.5ë°°ì”© ëŠ˜ë ¤ ìµœëŒ€ 5ì´ˆê¹Œì§€ ì¦ê°€í•©ë‹ˆë‹¤.
                format_resultëŠ” ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ì™€ SQLì„ ì¶”ì¶œí•˜ì—¬ ì½ê¸° ì‰¬ìš´ í˜•íƒœë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                ì´ íŒ¨í„´ì€ ë¹ ë¥¸ ì¿¼ë¦¬ëŠ” ì¦‰ì‹œ ê²°ê³¼ë¥¼ ë°›ê³ , ëŠë¦° ì¿¼ë¦¬ëŠ” ë¶ˆí•„ìš”í•œ API í˜¸ì¶œì„ ì¤„ì…ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 13: Exercise 01b main() -->
        <section>
            <h2>Exercise 01b: main() â€” ì§ˆì˜ íë¦„</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);">ëŒ€í™” ìƒì„± â†’ ì§ˆë¬¸ ì „ì†¡ â†’ í´ë§ â†’ ê²°ê³¼ ì¶œë ¥</p>
            <pre><code class="language-python" data-trim data-noescape style="font-size: 0.52em; line-height: 1.4;">
SPACE_ID = sys.argv[1]  # exercise_01aì—ì„œ ì¶œë ¥ëœ Space ID


def main():
    print("ğŸ” Exercise 01b: Genie Space ì§ˆì˜")
    print("=" * 60)
    print(f"  Space ID: {SPACE_ID}")

    conversation_id = create_conversation(SPACE_ID)
    print(f"     ëŒ€í™” ID: {conversation_id}")

    question = "What is the total online revenue for 2020?"
    print(f"  ì§ˆë¬¸ ì „ì†¡: '{question}'")
    result = send_message(SPACE_ID, conversation_id, question)
    message_id = result["message_id"]

    final = poll_result(SPACE_ID, conversation_id, message_id)
    print(f"\nâœ… ê²°ê³¼:")
    print(f"   {format_result(final)}")


if __name__ == "__main__":
    main()
            </code></pre>
            <div class="emphasis-box fragment" style="margin-top: 0.8em;">
                <strong>ì‹¤í–‰:</strong> <code>python exercise_01b_query_space.py &lt;SPACE_ID&gt;</code>
            </div>
            <aside class="notes">
                Exercise 01bì˜ main í•¨ìˆ˜ì…ë‹ˆë‹¤. ì§ˆì˜ì—ë§Œ ì§‘ì¤‘í•©ë‹ˆë‹¤.
                exercise_01aì—ì„œ ì¶œë ¥ëœ Space IDë¥¼ ì»¤ë§¨ë“œë¼ì¸ ì¸ìë¡œ ë°›ìŠµë‹ˆë‹¤.
                ëŒ€í™”ë¥¼ ìƒì„±í•˜ê³ , ì§ˆë¬¸ì„ ë³´ë‚´ê³ , ê²°ê³¼ë¥¼ í´ë§í•˜ì—¬ ì¶œë ¥í•©ë‹ˆë‹¤.
                ì´ë ‡ê²Œ ë¶„ë¦¬í•˜ë©´ ì´ë¯¸ ìƒì„±ëœ Spaceì— ëŒ€í•´ ì—¬ëŸ¬ ë²ˆ ì§ˆì˜ë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 14: Exercise 01b ì „ì²´ ì½”ë“œ -->
        <section>
            <h2>Exercise 01b ì „ì²´ ì½”ë“œ</h2>
            <p style="font-size: 0.6em; color: var(--ev-text-muted);">exercise_01b_query_space.py &mdash; ë³µì‚¬í•˜ì—¬ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥</p>
            <pre><code class="language-python" data-trim data-noescape data-line-numbers="1-16|29-36|43-97|100-123" style="font-size: 0.40em; line-height: 1.3;">
"""
Exercise 01b: Genie Space ì§ˆì˜
ìƒì„±ëœ Genie Spaceì— ìì—°ì–´ ì§ˆì˜ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

ì‚¬ìš©ë²•: python exercise_01b_query_space.py &lt;SPACE_ID&gt;
"""

import json
import os
import sys
import time

import httpx
from dotenv import load_dotenv

load_dotenv()

DATABRICKS_HOST = os.getenv("DATABRICKS_HOST", "").rstrip("/")
DATABRICKS_TOKEN = os.getenv("DATABRICKS_TOKEN", "")

if not all([DATABRICKS_HOST, DATABRICKS_TOKEN]):
    print("âš ï¸  .env íŒŒì¼ì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")
    print("   cp .env.example .env í›„ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.")
    print("   í•„ìš”: DATABRICKS_HOST, DATABRICKS_TOKEN")
    exit(1)

if len(sys.argv) < 2:
    print("âš ï¸  ì‚¬ìš©ë²•: python exercise_01b_query_space.py &lt;SPACE_ID&gt;")
    print("   exercise_01a_create_space.pyë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì—¬ Space IDë¥¼ ì–»ìœ¼ì„¸ìš”.")
    exit(1)

SPACE_ID = sys.argv[1]

headers = {
    "Authorization": f"Bearer {DATABRICKS_TOKEN}",
    "Content-Type": "application/json",
}


def create_conversation(space_id: str) -> str:
    """ìƒˆ Genie ëŒ€í™”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    resp = httpx.post(f"{base_url}/conversations", headers=headers)
    resp.raise_for_status()
    return resp.json()["conversation_id"]


def send_message(space_id: str, conversation_id: str, question: str) -> dict:
    """Genieì— ìì—°ì–´ ì§ˆë¬¸ì„ ë³´ëƒ…ë‹ˆë‹¤."""
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    resp = httpx.post(
        f"{base_url}/conversations/{conversation_id}/messages",
        headers=headers,
        json={"content": question},
    )
    resp.raise_for_status()
    return resp.json()


def poll_result(
    space_id: str,
    conversation_id: str,
    message_id: str,
    max_wait: int = 120,
) -> dict:
    """ê²°ê³¼ê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ì ì§„ì  ë°±ì˜¤í”„ë¡œ í´ë§í•©ë‹ˆë‹¤."""
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    url = f"{base_url}/conversations/{conversation_id}/messages/{message_id}"

    # ğŸ’¡ í•™ìŠµ í¬ì¸íŠ¸: ì ì§„ì  ë°±ì˜¤í”„ â€” ì´ˆë°˜ì—” ì§§ê²Œ, ì˜¤ë˜ ê±¸ë¦¬ë©´ ê°„ê²©ì„ ëŠ˜ë¦¼
    start = time.time()
    interval = 1.0
    while time.time() - start < max_wait:
        resp = httpx.get(url, headers=headers)
        resp.raise_for_status()
        data = resp.json()
        status = data.get("status", "")

        if status == "COMPLETED":
            return data
        if status in ("FAILED", "CANCELLED"):
            raise RuntimeError(f"Genie ì§ˆì˜ ì‹¤íŒ¨: {status}")

        elapsed = time.time() - start
        print(f"  â³ ìƒíƒœ: {status} ({elapsed:.0f}ì´ˆ ê²½ê³¼)")
        time.sleep(interval)
        interval = min(interval * 1.5, 5.0)  # ìµœëŒ€ 5ì´ˆê¹Œì§€ ì¦ê°€

    raise TimeoutError("Genie ì‘ë‹µ ì‹œê°„ ì´ˆê³¼")


def format_result(data: dict) -> str:
    """ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸/SQL ê²°ê³¼ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤."""
    attachments = data.get("attachments", [])
    parts = []
    for att in attachments:
        if "text" in att:
            parts.append(att["text"].get("content", ""))
        if "query" in att:
            parts.append(f"SQL: {att['query'].get('query', '')}")
    return "\n".join(parts) if parts else json.dumps(data, indent=2, ensure_ascii=False)


def main():
    print("ğŸ” Exercise 01b: Genie Space ì§ˆì˜")
    print("=" * 60)
    print(f"  Space ID: {SPACE_ID}")

    print("\n  1ï¸âƒ£ ëŒ€í™” ìƒì„± ì¤‘...")
    conversation_id = create_conversation(SPACE_ID)
    print(f"     ëŒ€í™” ID: {conversation_id}")

    question = "What is the total online revenue for 2020?"
    print(f"  2ï¸âƒ£ ì§ˆë¬¸ ì „ì†¡: '{question}'")
    result = send_message(SPACE_ID, conversation_id, question)
    message_id = result["message_id"]
    print(f"     ë©”ì‹œì§€ ID: {message_id}")

    print("  3ï¸âƒ£ ê²°ê³¼ ëŒ€ê¸° ì¤‘...")
    final = poll_result(SPACE_ID, conversation_id, message_id)
    print(f"\nâœ… ê²°ê³¼:")
    print(f"   {format_result(final)}")

    print(f"\nğŸ’¡ Tip: ìƒì„±ëœ Space IDë¥¼ exercise_02ì—ì„œ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    print(f"   Space ID: {SPACE_ID}")


if __name__ == "__main__":
    main()
            </code></pre>
            <aside class="notes">
                Exercise 01bì˜ ì „ì²´ ì½”ë“œì…ë‹ˆë‹¤. Copy ë²„íŠ¼ìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                í•˜ì´ë¼ì´íŠ¸ëœ êµ¬ê°„ì„ í™•ì¸í•´ë³´ì„¸ìš”:
                ì²« ë²ˆì§¸ â€” importì™€ í™˜ê²½ë³€ìˆ˜ ì„¤ì • (1-16í–‰)
                ë‘ ë²ˆì§¸ â€” Space ID ì…ë ¥ ì²˜ë¦¬ (29-36í–‰)
                ì„¸ ë²ˆì§¸ â€” ì§ˆì˜ API í•¨ìˆ˜ 4ê°œ (43-97í–‰) â€” create_conversation, send_message, poll_result, format_result
                ë„¤ ë²ˆì§¸ â€” main í•¨ìˆ˜ (100-123í–‰) â€” ëŒ€í™” ìƒì„±, ì§ˆë¬¸ ì „ì†¡, í´ë§, ê²°ê³¼ ì¶œë ¥
                exercise_01aì—ì„œ ì¶œë ¥ëœ Space IDë¥¼ ì¸ìë¡œ ì „ë‹¬í•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- ============================================================ -->
        <!-- Exercise 02: MCP ì„œë²„ (Slides 15-17) -->
        <!-- ============================================================ -->

        <!-- Slide 15: MCP ì„œë²„ ê¸°ë³¸ êµ¬ì¡° -->
        <section>
            <h2>MCP ì„œë²„ ê¸°ë³¸ êµ¬ì¡°</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);">FastMCP import, ì¸ìŠ¤í„´ìŠ¤ ìƒì„±, í—¬í¼ í•¨ìˆ˜ 2ê°œ</p>
            <pre><code class="language-python" data-trim data-noescape style="font-size: 0.48em; line-height: 1.4;">
import json
import os
import time
from uuid import uuid4

import httpx
from dotenv import load_dotenv
from fastmcp import FastMCP

load_dotenv()

DATABRICKS_HOST = os.getenv("DATABRICKS_HOST", "").rstrip("/")
DATABRICKS_TOKEN = os.getenv("DATABRICKS_TOKEN", "")
WAREHOUSE_ID = os.getenv("WAREHOUSE_ID", "")

if not all([DATABRICKS_HOST, DATABRICKS_TOKEN, WAREHOUSE_ID]):
    print("âš ï¸  .env íŒŒì¼ì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")
    exit(1)

mcp = FastMCP("Genie MCP")

headers = {
    "Authorization": f"Bearer {DATABRICKS_TOKEN}",
    "Content-Type": "application/json",
}


def _build_serialized_space(
    tables: list[dict], instructions: list[str], sample_questions: list[str],
    example_sqls: list[dict], join_specs: list[dict] | None = None,
    sql_snippets: dict | None = None,
) -> str:
    """protobuf v2 JSON í˜•ì‹ì˜ serialized_spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    inst_block: dict = {
        "text_instructions": [
            {"id": uuid4().hex, "content": [inst]} for inst in instructions
        ],
        "example_question_sqls": [
            {"id": uuid4().hex, "question": [ex["question"]], "sql": [ex["sql"]]}
            for ex in example_sqls
        ],
    }
    if join_specs:
        inst_block["join_specs"] = join_specs
    if sql_snippets:
        inst_block["sql_snippets"] = sql_snippets

    proto = {
        "version": 2,
        "data_sources": {
            "tables": [
                {"identifier": f"{t['catalog']}.{t['schema']}.{t['table']}"}
                for t in tables
            ]
        },
        "config": {
            "sample_questions": [
                {"id": uuid4().hex, "question": [q]} for q in sample_questions
            ]
        },
        "instructions": inst_block,
    }
    return json.dumps(proto)


def _send_and_poll(space_id: str, conversation_id: str, question: str) -> dict:
    """ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê³  ì ì§„ì  ë°±ì˜¤í”„ë¡œ ê²°ê³¼ë¥¼ í´ë§í•©ë‹ˆë‹¤."""
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    resp = httpx.post(
        f"{base_url}/conversations/{conversation_id}/messages",
        headers=headers, json={"content": question},
    )
    resp.raise_for_status()
    message_id = resp.json()["message_id"]

    url = f"{base_url}/conversations/{conversation_id}/messages/{message_id}"
    start = time.time()
    interval = 1.0
    max_wait = 120

    while time.time() - start < max_wait:
        resp = httpx.get(url, headers=headers)
        resp.raise_for_status()
        data = resp.json()
        status = data.get("status", "")
        if status == "COMPLETED":
            return data
        if status in ("FAILED", "CANCELLED"):
            return {"error": f"ì§ˆì˜ ì‹¤íŒ¨: {status}"}
        time.sleep(interval)
        interval = min(interval * 1.5, 5.0)

    return {"error": "ì‘ë‹µ ì‹œê°„ ì´ˆê³¼ (120ì´ˆ)"}
            </code></pre>
            <aside class="notes">
                Exercise 02ì˜ MCP ì„œë²„ ì½”ë“œì…ë‹ˆë‹¤.
                Exercise 01ê³¼ ë™ì¼í•œ importì™€ í™˜ê²½ë³€ìˆ˜ ì„¤ì •ì´ì§€ë§Œ, FastMCPë¥¼ ì¶”ê°€ë¡œ importí•©ë‹ˆë‹¤.
                mcp = FastMCP("Genie MCP")ë¡œ MCP ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                _build_serialized_spaceì™€ _send_and_pollì€ ë‚´ë¶€ í—¬í¼ í•¨ìˆ˜ë¡œ,
                Exercise 01ì˜ í•¨ìˆ˜ë¥¼ MCP ì„œë²„ìš©ìœ¼ë¡œ ì •ë¦¬í•œ ê²ƒì…ë‹ˆë‹¤.
                ë‹¤ìŒ ìŠ¬ë¼ì´ë“œì—ì„œ ì´ í—¬í¼ë¥¼ ì‚¬ìš©í•˜ëŠ” 3ê°œì˜ MCP toolì„ ë³´ê² ìŠµë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 16: MCP Tools â€” 3ê°œ tool ì •ì˜ -->
        <section>
            <h2>MCP Tools: 3ê°œ tool ì •ì˜</h2>
            <p style="font-size: 0.7em; color: var(--ev-text-muted);"><code>@mcp.tool()</code> ë°ì½”ë ˆì´í„°ë¡œ create_genie_space, ask_genie, continue_conversation</p>
            <pre><code class="language-python" data-trim data-noescape style="font-size: 0.48em; line-height: 1.4;">
@mcp.tool()
def create_genie_space(
    title: str, description: str, warehouse_id: str, tables: list[dict],
    instructions: list[str] | None = None, sample_questions: list[str] | None = None,
    example_sqls: list[dict] | None = None, join_specs: list[dict] | None = None,
    sql_snippets: dict | None = None,
) -> str:
    """Databricks Genie Spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    serialized = _build_serialized_space(
        tables=tables, instructions=instructions or [],
        sample_questions=sample_questions or [], example_sqls=example_sqls or [],
        join_specs=join_specs, sql_snippets=sql_snippets,
    )
    resp = httpx.post(
        f"{DATABRICKS_HOST}/api/2.0/genie/spaces", headers=headers,
        json={
            "title": title, "description": description,
            "warehouse_id": warehouse_id, "serialized_space": serialized,
        },
    )
    resp.raise_for_status()
    data = resp.json()
    space_id = data.get("space_id", "unknown")
    return f"Space ìƒì„± ì™„ë£Œ\nSpace ID: {space_id}\nTitle: {title}"


@mcp.tool()
def ask_genie(space_id: str, question: str) -> str:
    """Databricks Genieì— ìì—°ì–´ë¡œ ë°ì´í„°ë¥¼ ì§ˆì˜í•©ë‹ˆë‹¤. ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."""
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    resp = httpx.post(f"{base_url}/conversations", headers=headers)
    resp.raise_for_status()
    conversation_id = resp.json()["conversation_id"]

    result = _send_and_poll(space_id, conversation_id, question)
    response = _format_response(result)
    return f"{response}\n\n(conversation_id: {conversation_id})"


@mcp.tool()
def continue_conversation(
    space_id: str, conversation_id: str, question: str,
) -> str:
    """ê¸°ì¡´ Genie ëŒ€í™”ì— í›„ì† ì§ˆë¬¸ì„ í•©ë‹ˆë‹¤."""
    result = _send_and_poll(space_id, conversation_id, question)
    return _format_response(result)


if __name__ == "__main__":
    mcp.run()
            </code></pre>
            <aside class="notes">
                3ê°œì˜ MCP toolì…ë‹ˆë‹¤.
                create_genie_space â€” í…Œì´ë¸”, ì§€ì‹œì‚¬í•­ ë“±ì„ ë°›ì•„ ë‚´ë¶€ì—ì„œ serialized_spaceë¥¼ êµ¬ì„±í•˜ê³  Spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                ask_genie â€” ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ê³  ì§ˆì˜í•©ë‹ˆë‹¤. ëŒ€í™” ìƒì„±, ë©”ì‹œì§€ ì „ì†¡, í´ë§ì„ ëª¨ë‘ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                continue_conversation â€” ê¸°ì¡´ ëŒ€í™”ì— í›„ì† ì§ˆë¬¸ì„ í•©ë‹ˆë‹¤. conversation_idë¥¼ ë°›ì•„ ê°™ì€ ëŒ€í™”ì— ì´ì–´ê°‘ë‹ˆë‹¤.
                @mcp.tool() ë°ì½”ë ˆì´í„°ë§Œ ë¶™ì´ë©´ FastMCPê°€ ìë™ìœ¼ë¡œ toolì„ ë“±ë¡í•©ë‹ˆë‹¤.
                ë§ˆì§€ë§‰ mcp.run()ìœ¼ë¡œ ì„œë²„ê°€ ì‹œì‘ë©ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 17: Exercise 02 ì „ì²´ ì½”ë“œ -->
        <section>
            <h2>Exercise 02 ì „ì²´ ì½”ë“œ</h2>
            <p style="font-size: 0.6em; color: var(--ev-text-muted);">exercise_02_genie_mcp_server.py &mdash; ë³µì‚¬í•˜ì—¬ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥</p>
            <pre><code class="language-python" data-trim data-noescape data-line-numbers="1-28|41-85|88-116|139-191|194-232" style="font-size: 0.38em; line-height: 1.3;">
"""
Exercise 02: Genie MCP ì„œë²„
Databricks Genieë¥¼ MCP ì„œë²„ë¡œ ë˜í•‘í•˜ì—¬ Claude Codeì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
Space ìƒì„±, ì§ˆì˜, í›„ì† ì§ˆì˜ 3ê°œ toolì„ ì œê³µí•©ë‹ˆë‹¤.

ì‹¤í–‰: python exercise_02_genie_mcp_server.py
"""

import json
import os
import time
from uuid import uuid4

import httpx
from dotenv import load_dotenv
from fastmcp import FastMCP

load_dotenv()

DATABRICKS_HOST = os.getenv("DATABRICKS_HOST", "").rstrip("/")
DATABRICKS_TOKEN = os.getenv("DATABRICKS_TOKEN", "")
WAREHOUSE_ID = os.getenv("WAREHOUSE_ID", "")

if not all([DATABRICKS_HOST, DATABRICKS_TOKEN, WAREHOUSE_ID]):
    print("âš ï¸  .env íŒŒì¼ì— í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")
    exit(1)

mcp = FastMCP("Genie MCP")

headers = {
    "Authorization": f"Bearer {DATABRICKS_TOKEN}",
    "Content-Type": "application/json",
}


# ============================================================
# ë‚´ë¶€ í—¬í¼ í•¨ìˆ˜
# ============================================================


def _build_serialized_space(
    tables: list[dict],
    instructions: list[str],
    sample_questions: list[str],
    example_sqls: list[dict],
    join_specs: list[dict] | None = None,
    sql_snippets: dict | None = None,
) -> str:
    """protobuf v2 JSON í˜•ì‹ì˜ serialized_spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    inst_block: dict = {
        "text_instructions": [
            {"id": uuid4().hex, "content": [inst]} for inst in instructions
        ],
        "example_question_sqls": [
            {
                "id": uuid4().hex,
                "question": [ex["question"]],
                "sql": [ex["sql"]],
            }
            for ex in example_sqls
        ],
    }

    if join_specs:
        inst_block["join_specs"] = join_specs

    if sql_snippets:
        inst_block["sql_snippets"] = sql_snippets

    proto = {
        "version": 2,
        "data_sources": {
            "tables": [
                {"identifier": f"{t['catalog']}.{t['schema']}.{t['table']}"}
                for t in tables
            ]
        },
        "config": {
            "sample_questions": [
                {"id": uuid4().hex, "question": [q]} for q in sample_questions
            ]
        },
        "instructions": inst_block,
    }
    return json.dumps(proto)


def _send_and_poll(space_id: str, conversation_id: str, question: str) -> dict:
    """ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ê³  ì ì§„ì  ë°±ì˜¤í”„ë¡œ ê²°ê³¼ë¥¼ í´ë§í•©ë‹ˆë‹¤."""
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    resp = httpx.post(
        f"{base_url}/conversations/{conversation_id}/messages",
        headers=headers,
        json={"content": question},
    )
    resp.raise_for_status()
    message_id = resp.json()["message_id"]

    url = f"{base_url}/conversations/{conversation_id}/messages/{message_id}"
    start = time.time()
    interval = 1.0
    max_wait = 120

    while time.time() - start < max_wait:
        resp = httpx.get(url, headers=headers)
        resp.raise_for_status()
        data = resp.json()
        status = data.get("status", "")
        if status == "COMPLETED":
            return data
        if status in ("FAILED", "CANCELLED"):
            return {"error": f"ì§ˆì˜ ì‹¤íŒ¨: {status}"}
        time.sleep(interval)
        interval = min(interval * 1.5, 5.0)

    return {"error": "ì‘ë‹µ ì‹œê°„ ì´ˆê³¼ (120ì´ˆ)"}


def _format_response(result: dict) -> str:
    """Genie ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸/SQL ê²°ê³¼ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤."""
    if "error" in result:
        return f"ì˜¤ë¥˜: {result['error']}"

    attachments = result.get("attachments", [])
    parts = []
    for att in attachments:
        if "text" in att:
            parts.append(att["text"].get("content", ""))
        if "query" in att:
            parts.append(f"SQL: {att['query'].get('query', '')}")
    return "\n".join(parts) if parts else json.dumps(result, indent=2, ensure_ascii=False)


# ============================================================
# MCP Tools
# ============================================================


@mcp.tool()
def create_genie_space(
    title: str,
    description: str,
    warehouse_id: str,
    tables: list[dict],
    instructions: list[str] | None = None,
    sample_questions: list[str] | None = None,
    example_sqls: list[dict] | None = None,
    join_specs: list[dict] | None = None,
    sql_snippets: dict | None = None,
) -> str:
    """Databricks Genie Spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

    Args:
        title: Space ì œëª©
        description: Space ì„¤ëª…
        warehouse_id: SQL Warehouse ID
        tables: í¬í•¨í•  í…Œì´ë¸” ëª©ë¡ [{"catalog": "...", "schema": "...", "table": "..."}]
        instructions: í…ìŠ¤íŠ¸ ì§€ì‹œì‚¬í•­ (ì˜ˆ: ["í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”"])
        sample_questions: ì˜ˆì œ ì§ˆë¬¸ (ì˜ˆ: ["ì´ ë§¤ì¶œì€?"])
        example_sqls: ì˜ˆì œ SQL [{"question": "...", "sql": "..."}]
        join_specs: í…Œì´ë¸” ê°„ ì¡°ì¸ ì¡°ê±´ ë¦¬ìŠ¤íŠ¸
        sql_snippets: SQL ìŠ¤ë‹ˆí« (expressions, measures, filters)

    Returns:
        ìƒì„±ëœ Space ì •ë³´ (space_id í¬í•¨)
    """
    serialized = _build_serialized_space(
        tables=tables,
        instructions=instructions or [],
        sample_questions=sample_questions or [],
        example_sqls=example_sqls or [],
        join_specs=join_specs,
        sql_snippets=sql_snippets,
    )

    resp = httpx.post(
        f"{DATABRICKS_HOST}/api/2.0/genie/spaces",
        headers=headers,
        json={
            "title": title,
            "description": description,
            "warehouse_id": warehouse_id,
            "serialized_space": serialized,
        },
    )
    resp.raise_for_status()
    data = resp.json()
    space_id = data.get("space_id", "unknown")
    return f"Space ìƒì„± ì™„ë£Œ\nSpace ID: {space_id}\nTitle: {title}"


@mcp.tool()
def ask_genie(space_id: str, question: str) -> str:
    """Databricks Genieì— ìì—°ì–´ë¡œ ë°ì´í„°ë¥¼ ì§ˆì˜í•©ë‹ˆë‹¤. ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.

    Args:
        space_id: Genie Space ID
        question: ë°ì´í„°ì— ëŒ€í•œ ìì—°ì–´ ì§ˆë¬¸ (ì˜ˆ: 'ì´ë²ˆ ë‹¬ ë§¤ì¶œì€?')

    Returns:
        Genieì˜ ì‘ë‹µ ê²°ê³¼ (í…ìŠ¤íŠ¸ + SQL)
    """
    base_url = f"{DATABRICKS_HOST}/api/2.0/genie/spaces/{space_id}"
    resp = httpx.post(f"{base_url}/conversations", headers=headers)
    resp.raise_for_status()
    conversation_id = resp.json()["conversation_id"]

    result = _send_and_poll(space_id, conversation_id, question)
    response = _format_response(result)
    return f"{response}\n\n(conversation_id: {conversation_id})"


@mcp.tool()
def continue_conversation(
    space_id: str,
    conversation_id: str,
    question: str,
) -> str:
    """ê¸°ì¡´ Genie ëŒ€í™”ì— í›„ì† ì§ˆë¬¸ì„ í•©ë‹ˆë‹¤.

    Args:
        space_id: Genie Space ID
        conversation_id: ê¸°ì¡´ ëŒ€í™” ID (ask_genie ê²°ê³¼ì—ì„œ í™•ì¸)
        question: í›„ì† ì§ˆë¬¸ (ì˜ˆ: 'ì›”ë³„ë¡œ ë‚˜ëˆ ì„œ ë³´ì—¬ì¤˜')

    Returns:
        Genieì˜ ì‘ë‹µ ê²°ê³¼
    """
    result = _send_and_poll(space_id, conversation_id, question)
    return _format_response(result)


if __name__ == "__main__":
    mcp.run()
            </code></pre>
            <aside class="notes">
                Exercise 02ì˜ ì „ì²´ ì½”ë“œì…ë‹ˆë‹¤. Copy ë²„íŠ¼ìœ¼ë¡œ ë³µì‚¬í•˜ì—¬ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                í•˜ì´ë¼ì´íŠ¸ëœ êµ¬ê°„ì„ í™•ì¸í•´ë³´ì„¸ìš”:
                ì²« ë²ˆì§¸ â€” import, í™˜ê²½ë³€ìˆ˜, FastMCP ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (1-28í–‰)
                ë‘ ë²ˆì§¸ â€” _build_serialized_space í—¬í¼ (41-85í–‰)
                ì„¸ ë²ˆì§¸ â€” _send_and_poll í—¬í¼ (88-116í–‰)
                ë„¤ ë²ˆì§¸ â€” create_genie_space tool (139-191í–‰)
                ë‹¤ì„¯ ë²ˆì§¸ â€” ask_genie + continue_conversation tool (194-232í–‰)
                Exercise 01ê³¼ ë¡œì§ì€ ë™ì¼í•˜ì§€ë§Œ @mcp.tool() ë°ì½”ë ˆì´í„°ë¡œ MCP ì„œë²„ê°€ ë©ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- ============================================================ -->
        <!-- ë§ˆë¬´ë¦¬ (Slides 18-19) -->
        <!-- ============================================================ -->

        <!-- Slide 18: Claude Code ì—°ê²° + ì‹¤ìŠµ ì•ˆë‚´ -->
        <section>
            <h2>Claude Code ì—°ê²° + ì‹¤ìŠµ ì•ˆë‚´</h2>
            <h3>settings.local.json ì„¤ì •</h3>
            <pre><code class="language-json" data-trim data-noescape>
{
  "mcpServers": {
    "genie": {
      "command": "python",
      "args": ["exercise_02_genie_mcp_server.py"],
      "cwd": "./sections/05-genie-mcp"
    }
  }
}
            </code></pre>
            <h3 style="margin-top: 0.8em;">ëŒ€í™” ì˜ˆì‹œ</h3>
            <div class="emphasis-box" style="font-size: 0.75em;">
                <p><strong>ì‚¬ìš©ì:</strong> "Fashion Recommendations ë°ì´í„°ë¡œ Genie Spaceë¥¼ ë§Œë“¤ì–´ì¤˜"</p>
                <p><strong>Claude:</strong> <code>create_genie_space</code> toolë¡œ Spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                <p style="margin-top: 0.5em;"><strong>ì‚¬ìš©ì:</strong> "ë§¤ì¶œ Top 10 ìƒí’ˆì„ ì•Œë ¤ì¤˜"</p>
                <p><strong>Claude:</strong> <code>ask_genie</code> toolë¡œ ì§ˆì˜í•©ë‹ˆë‹¤.</p>
                <p style="margin-top: 0.5em;"><strong>ì‚¬ìš©ì:</strong> "ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ë³„ë¡œ ë‚˜ëˆ ì„œ ë³´ì—¬ì¤˜"</p>
                <p><strong>Claude:</strong> <code>continue_conversation</code> toolë¡œ í›„ì† ì§ˆì˜í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="emphasis-box fragment" style="margin-top: 0.8em;">
                <strong>ì‹¤ìŠµ:</strong> <code>databricks configure</code> ì„¤ì • â†’ Exercise 00 ì²´í¬ë¦¬ìŠ¤íŠ¸ â†’ 01a â†’ 01b â†’ Exercise 02ë¥¼ Claude Codeì— ì—°ê²°
            </div>
            <aside class="notes">
                Claude Codeì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ settings.local.jsonì— MCP ì„œë²„ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
                ë“±ë¡ í›„ Claude Codeì—ì„œ Space ìƒì„±ì„ ìš”ì²­í•˜ë©´ create_genie_space toolì´ í˜¸ì¶œë©ë‹ˆë‹¤.
                ìƒì„±ëœ Spaceì— ì§ˆë¬¸í•˜ë©´ ask_genie toolì´, í›„ì† ì§ˆë¬¸ì€ continue_conversation toolì´ í˜¸ì¶œë©ë‹ˆë‹¤.
                ì‹¤ìŠµì€ ë„¤ ë‹¨ê³„ì…ë‹ˆë‹¤: ë¨¼ì € .env íŒŒì¼ì„ ì„¤ì •í•˜ê³  Exercise 00ìœ¼ë¡œ í™˜ê²½ì„ ê²€ì¦í•©ë‹ˆë‹¤. ê·¸ ë‹¤ìŒ Exercise 01aë¡œ Spaceë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                ê·¸ ë‹¤ìŒ Exercise 01bë¡œ ìƒì„±í•œ Spaceì— ì§ˆì˜í•©ë‹ˆë‹¤.
                ë§ˆì§€ë§‰ìœ¼ë¡œ Exercise 02ë¥¼ Claude Codeì— ì—°ê²°í•˜ì—¬ ìì—°ì–´ë¡œ Space ìƒì„±ê³¼ ì§ˆì˜ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            </aside>
        </section>

        <!-- Slide 19: ì •ë¦¬ & Q&A -->
        <section>
            <h2>ì •ë¦¬ & Q&A</h2>
            <ul>
                <li><strong>Space ìƒì„± API</strong>: serialized_space(protobuf v2)ë¡œ í…Œì´ë¸”/ì§€ì‹œì‚¬í•­ ì •ì˜</li>
                <li><strong>ì§ˆì˜ API</strong>: ëŒ€í™” ìƒì„± &rarr; ë©”ì‹œì§€ ì „ì†¡ &rarr; ì ì§„ì  ë°±ì˜¤í”„ í´ë§</li>
                <li><strong>3ê°œ Tool MCP</strong>: create_genie_space + ask_genie + continue_conversation</li>
                <li><strong>Claude Code ì—°ë™</strong>: Space ìƒì„±ë¶€í„° ì§ˆì˜ê¹Œì§€ ìì—°ì–´ë¡œ ìˆ˜í–‰</li>
            </ul>
            <div class="emphasis-box" style="margin-top: 1.5em;">
                <strong>ë‹¤ìŒ ì„¹ì…˜:</strong> Skills Workflow &mdash; MCP ì„œë²„ë“¤ì„ Skillë¡œ ì¡°í•©í•˜ì—¬ ì›Œí¬í”Œë¡œìš° êµ¬ì„±
            </div>
            <aside class="notes">
                ì´ë²ˆ ì„¹ì…˜ì˜ í•µì‹¬ì„ ì •ë¦¬í•©ë‹ˆë‹¤.
                Genie Spaceë¥¼ APIë¡œ ì§ì ‘ ìƒì„±í•˜ëŠ” ë°©ë²•ê³¼ serialized_spaceì˜ protobuf v2 í˜•ì‹ì„ ë°°ì› ìŠµë‹ˆë‹¤.
                ì§ˆì˜ APIì˜ 3ë‹¨ê³„ êµ¬ì¡°ì™€ ì ì§„ì  ë°±ì˜¤í”„ í´ë§ íŒ¨í„´ì„ ì´í•´í–ˆìŠµë‹ˆë‹¤.
                ì´ë¥¼ 3ê°œì˜ MCP toolë¡œ ë˜í•‘í•˜ì—¬ Claude Codeì—ì„œ ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ ìì—°ì–´ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ í–ˆìŠµë‹ˆë‹¤.
                ì´ íŒ¨í„´ì€ Genieë¿ ì•„ë‹ˆë¼ ë‹¤ë¥¸ Databricks APIë‚˜ ì™¸ë¶€ ì„œë¹„ìŠ¤ë¥¼ MCPë¡œ ë§Œë“¤ ë•Œë„ ë™ì¼í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤.
                ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ììœ ë¡­ê²Œ í•´ì£¼ì„¸ìš”.
            </aside>
        </section>

    </div></div>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/notes/notes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/highlight/highlight.js"></script>
    <script>
        Reveal.initialize({ hash: true, slideNumber: true, plugins: [RevealNotes, RevealHighlight] });
    </script>
    <script src="../../shared/scripts/sidebar.js"></script>
    <script src="../../shared/scripts/copy-code.js"></script>
</body>
</html>
